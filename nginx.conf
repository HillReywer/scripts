# FORGE CONFIG (DO NOT REMOVE!)
include forge-conf/v3-site.wingly.rocks/before/*;

# Redirects

map $request_uri $redirect {
    # Do not redirect anything that do not match this list
    default 0;
}

map $sent_http_content_type $expires {
    # default
    "text/html" epoch;
    "text/html; charset=utf-8" epoch;
    default off;

    #  new policy
    # "text/html"                 1h; # set this to your needs
    # "text/html; charset=utf-8"  1h; # set this to your needs
    #  default                     1y; # set this to your needs
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name staging.wingly.rocks;
    server_tokens off;
    root /home/forge/v3-site.wingly.rocks/public;

    gzip on;
    gzip_types text/plain application/xml text/css application/javascript;
    gzip_min_length 1000;

    # FORGE SSL (DO NOT REMOVE!)
    ssl_certificate /etc/letsencrypt/live/staging.wingly.rocks/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/staging.wingly.rocks/privkey.pem;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_dhparam /etc/nginx/dhparams.pem;

    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-XSS-Protection "1; mode=block";
    add_header X-Content-Type-Options "nosniff";

    index index.html index.htm index.php;

    charset utf-8;

    # FORGE CONFIG (DO NOT REMOVE!)
    include forge-conf/v3-site.wingly.rocks/server/*;

    location / {
        expires $expires;

        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 1m;
        proxy_connect_timeout 1m;
        proxy_pass http://127.0.0.1:3000; # set the address of the Node.js instance here
    }

    location = /favicon.ico {
        access_log off; log_not_found off;
    }
    location = /robots.txt {
        access_log off; log_not_found off;
    }

    access_log off;
    error_log /var/log/nginx/v3-site.wingly.rocks-error.log error;

    error_page 404 /index.php;

    location ~ \.php$ {
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;
        fastcgi_index index.php;
        include fastcgi_params;
    }

    rewrite ^/(en|fr|fr-ch|de|de-at|de-ch)/landingpages/commercial-operator$ /$1/commercial-operators permanent;
    rewrite ^/(en|fr|fr-ch|de|de-at|de-ch)/users$ /$1/dashboard permanent;
    rewrite ^/(en|fr|fr-ch|de|de-at|de-ch)/users/show/(\d+)$ /$1/users/$2 permanent;
    rewrite ^/(en|fr|fr-ch|de|de-at|de-ch)/aircraft$ /$1/aircrafts permanent;
    rewrite ^/(en|fr|fr-ch|de|de-at|de-ch)/aircraft/([^/]+)/?$ /$1/aircrafts/$2 permanent;
    rewrite ^/(en|fr|fr-ch|de|de-at|de-ch)/aircraft/([^/]+)/([^/]+)/?$ /$1/aircrafts/$2/$3 permanent;
    rewrite ^/(en|fr|fr-ch|de|de-at|de-ch)/landingpages/gift-cards/couples$ /$1/gift-cards/couples permanent;
    rewrite ^/(en|fr|fr-ch|de|de-at|de-ch)/landingpages/register-passenger$ /$1/register permanent;
    rewrite ^/(en|fr|fr-ch|de|de-at|de-ch)/landingpages/company$ /$1/b2b-sales/gift-cards permanent;
    rewrite ^/(en|fr|fr-ch|de|de-at|de-ch)/landingpages/companies-ota$ /$1/b2b-sales/flights permanent;
    rewrite ^/(en|fr|fr-ch|de|de-at|de-ch)/users/messages$ /$1/threads permanent;
    rewrite ^/(en|fr|fr-ch|de|de-at|de-ch)/users/messages/show/(\d+)$ /$1/threads/$2 permanent;
    rewrite ^/(en|fr|fr-ch|de|de-at|de-ch)/users/gift-cards/payments$ /$1/orders permanent;
    rewrite ^/(en|fr|fr-ch|de|de-at|de-ch)/shop/gift-cards$ /$1/gift-cards permanent;
    rewrite ^/(en|fr|fr-ch|de|de-at|de-ch)/shop/gift-flights/(\d+)$ /$1/flights/$2/gift permanent;
    rewrite ^/(en|fr|fr-ch|de|de-at|de-ch)/users/aircraft$ /$1/cockpit/aircraft permanent;
    rewrite ^/(en|fr|fr-ch|de|de-at|de-ch)/users/aircraft/create$ /$1/cockpit/aircraft/create permanent;
    rewrite ^/(en|fr|fr-ch|de|de-at|de-ch)/users/aircraft/(\d+)/edit$ /$1/cockpit/aircraft/$2/update permanent;
    rewrite ^/(en|fr|fr-ch|de|de-at|de-ch)/users/calendar$ /$1/cockpit/calendar permanent;
    rewrite ^/(en|fr|fr-ch|de|de-at|de-ch)/users/flights$ /$1/cockpit/flights/completed permanent;
    rewrite ^/(en|fr|fr-ch|de|de-at|de-ch)/users/flights/patterns$ /$1/cockpit/flights/create permanent;
    rewrite ^/(en|fr|fr-ch|de|de-at|de-ch)/users/flights/create$ /$1/cockpit/flights/create permanent;
    rewrite ^/(en|fr|fr-ch|de|de-at|de-ch)/users/flights/(\d+)/edit$ /$1/cockpit/flights/$2/update permanent;
    rewrite ^/(en|fr|fr-ch|de|de-at|de-ch)/users/ffa$ /$1/account/pilot-info permanent;
    rewrite ^/(en|fr|fr-ch|de|de-at|de-ch)/users/edit$ /$1/account/personal-info permanent;
    rewrite ^/(en|fr|fr-ch|de|de-at|de-ch)/users/verifications$ /$1/account/pilot-info permanent;
    rewrite ^/(en|fr|fr-ch|de|de-at|de-ch)/users/flight-logs/edit$ /$1/account/pilot-info permanent;
    rewrite ^/(en|fr|fr-ch|de|de-at|de-ch)/users/homebases$ /$1/account/pilot-info permanent;
    rewrite ^/(en|fr|fr-ch|de|de-at|de-ch)/users/qualifications/edit$ /$1/account/pilot-info permanent;
    rewrite ^/(en|fr|fr-ch|de|de-at|de-ch)/users/notifications/permissions/edit$ /$1/account/notifications permanent;
    rewrite ^/(en|fr|fr-ch|de|de-at|de-ch)/users/settings$ /$1/account/security permanent;
    rewrite ^/(en|fr|fr-ch|de|de-at|de-ch)/users/payouts-preferences$ /$1/account/payments permanent;
    rewrite ^/(en|fr|fr-ch|de|de-at|de-ch)/users/gift-cards$ /$1/account/gift-cards permanent;
    rewrite ^/(en|fr|fr-ch|de|de-at|de-ch)/users/flights/cancel/(\d+)/create$ /$1/cockpit/bookings/scheduled permanent;
    rewrite ^/(en|fr|fr-ch|de|de-at|de-ch)/users/flights/reschedule/(\d+)/create$ /$1/cockpit/bookings/scheduled permanent;
    rewrite ^/(en|fr|fr-ch|de|de-at|de-ch)/users/bookings$ /$1/bookings/scheduled permanent;
    rewrite ^/(en|fr|fr-ch|de|de-at|de-ch)/users/bookings/(\d+)/show$ /$1/bookings/scheduled permanent;
    rewrite ^/(en|fr|fr-ch|de|de-at|de-ch)/flights\?departure_city=(.*)$ /$1/flights/search?address=$2 permanent;
    rewrite ^/(en|fr|fr-ch|de|de-at|de-ch)/users/bookings/archived$ /$1/bookings/requests permanent;
    rewrite ^/(en|fr|fr-ch|de|de-at|de-ch)/flights$ /$1/flights/search permanent;
    rewrite ^/(en|fr|fr-ch|de|de-at|de-ch)/users/bookings/cancel/(\d+)/create$ /$1/bookings/scheduled/$2/cancel permanent;
    rewrite ^/(en|fr|fr-ch|de|de-at|de-ch)/users/bookings/reschedule/(\d+)/create$ /$1/bookings/requests/$2/reschedule permanent;
    rewrite ^/(en|fr|fr-ch|de|de-at|de-ch)/users/bookings/ratings/(\d+)/create$ /$1/bookings/scheduled/$2 permanent;
    rewrite ^/(en|fr|fr-ch|de|de-at|de-ch)/users/booking-requests/show/(\d+)$ /$1/bookings/scheduled permanent;
    rewrite ^/(en|fr|fr-ch|de|de-at|de-ch)/users/booking-requests/cancel/(\d+)$ /$1/bookings/scheduled permanent;
    rewrite ^/(en|fr|fr-ch|de|de-at|de-ch)/users/booking-requests/show/(\d+)$ /$1/bookings/scheduled permanent;
    rewrite ^/(en|fr|fr-ch|de|de-at|de-ch)/users/payouts$ /$1/cockpit/payouts permanent;


    location ~ /\.(?!well-known).* {
        deny all;
    }
}

# FORGE CONFIG (DO NOT REMOVE!)
include forge-conf/v3-site.wingly.rocks/after/*;